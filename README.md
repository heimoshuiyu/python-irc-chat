# python-irc-chat

è¿™æ˜¯ networking çš„è¯¾ç¨‹ä½œä¸šã€‚ç”¨ socket æŠ€æœ¯å®ç° B/S æ¨¡å¼çš„èŠå¤©ï¼ˆæ”¯æŒç§èŠã€ç¾¤èŠï¼‰ã€‚åè®®è®¾è®¡å‚è€ƒäº† IRCã€‚

## ä¾èµ–

- `python 3.x`
- `tkinter` å›¾å½¢åº“ï¼ˆéå¿…è¦ï¼‰

## ä½¿ç”¨

å…ˆå¯åŠ¨æœåŠ¡ç«¯ `server.py`

å†å¯åŠ¨å®¢æˆ·ç«¯ `client.py`

åœ¨å®¢æˆ·ç«¯ä¸­è¾“å…¥ `<ç”¨æˆ·å> [<å¯†ç >]`ï¼Œä»¥ç©ºæ ¼åˆ†å‰²ï¼Œå¯†ç æ˜¯å¯é€‰çš„ã€‚å¦‚æœä½¿ç”¨å¯†ç ï¼ŒæœåŠ¡ç«¯å°†åœ¨æ•°æ®åº“ä¸­è®°å½•ç”¨æˆ·æ˜µç§°å’Œå¯†ç ï¼Œä¸‹æ¬¡ç™»å½•è¯¥ç”¨æˆ·éœ€è¦ä½¿ç”¨ç›¸åŒçš„å¯†ç ã€‚

> é¢‘é“åç§°å¿…é¡»ä»¥äº•å· `#` å¼€å¤´

- å®¢æˆ·ç«¯ä¸­è¾“å…¥ `/help` å¯ä»¥æŸ¥çœ‹å‘½ä»¤å¸®åŠ©ï¼›
- è¾“å…¥ `/msg nickname hello` å¯ä»¥å°†æ¶ˆæ¯ hello å‘é€ç»™æš±ç§°ä¸º nickname çš„ç”¨æˆ·ï¼›
- è¾“å…¥ `/join #channel` å¯ä»¥åŠ å…¥åä¸º `#channel` çš„é¢‘é“ï¼ŒåŠ å…¥é¢‘é“çš„ç”¨æˆ·å°†ä¼šæ”¶åˆ°æ¥è‡ªè¯¥é¢‘é“çš„æ¶ˆæ¯ï¼Œä¸å­˜åœ¨çš„é¢‘é“å°†ä¼šè‡ªåŠ¨åˆ›å»ºï¼Œæ²¡äººçš„é¢‘é“å°†ä¼šè‡ªåŠ¨é”€æ¯ã€‚
- è¾“å…¥ `/msg #channel hello` å¯ä»¥å°†æ¶ˆæ¯ hello å‘é€ç»™åœ¨é¢‘é“ `#channel` é‡Œçš„æ‰€æœ‰ç”¨æˆ·ã€‚
- è¾“å…¥ `/part #channel` å¯ä»¥é€€å‡ºä¸€ä¸ªé¢‘é“

å¦‚æœè¾“å…¥çš„ä¸æ˜¯å‘½ä»¤ï¼ˆä¸ä»¥ `/` å¼€å¤´ï¼‰ï¼Œåˆ™ä¼šè‡ªåŠ¨è®¤ä¸ºè¿™æ˜¯ä¸€ä¸ª `/msg` å‘½ä»¤å¹¶å‘é€åˆ° `defaultTarget`

`/msg` `/join` `/part` ä¼šæ”¹å˜ `defaultTarget`ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå…ˆè¾“å…¥ `/msg user hello` ç»™ user å‘é€äº†æ¶ˆæ¯ï¼Œä¹‹åæ¥ç€å‘ user å‘é€æ¶ˆæ¯éƒ½ä¸éœ€è¦è¾“å…¥å‰é¢çš„ `/msg user` ç›´æ¥è¾“å…¥æ¶ˆæ¯å†…å®¹å³å¯ã€‚

## åŸç†

ä¸€ä¸ªå®Œæ•´çš„å®¢æˆ·ç«¯å‘å¦ä¸€ä¸ªå®¢æˆ·ç«¯å‘é€æ¶ˆæ¯æµç¨‹

1. å®¢æˆ·ç«¯å‘æœåŠ¡ç«¯ä½¿ç”¨ `/nick` å‘½ä»¤ä¼ é€’è‡ªå·±çš„æ˜µç§°ï¼Œè¡¨ç¤ºä¸Šçº¿

2. æœåŠ¡ç«¯å°†ç”¨æˆ·æ˜µç§°å’Œé“¾æ¥å‚¨å­˜åœ¨ `connDict` å­—å…¸ä¸­

3. å®¢æˆ·ç«¯å‘æœåŠ¡ç«¯ä½¿ç”¨ `/msg` å‘½ä»¤å‘é€æ¶ˆæ¯åˆ°æŒ‡å®šçš„æ˜µç§°

4. æœåŠ¡ç«¯åœ¨å†…éƒ¨ç»´æŠ¤çš„ `connDict` å­—å…¸ä¸­å¯»æ‰¾ç›®æ ‡é“¾æ¥

5. æœåŠ¡ç«¯ä¿®æ”¹æ¶ˆæ¯å‰ç¼€ `prefix` è¡¨ç¤ºæ¶ˆæ¯æ¥æºäºæ­¤æ˜µç§°

6. æœåŠ¡ç«¯å°†ä¿®æ”¹åçš„æ¶ˆæ¯å‘é€ç»™ç›®æ ‡æ˜µç§°

### ç¼–ç¨‹ä¸Šä¸€äº›å®ç°ç»†èŠ‚

### `message.py`

å®šä¹‰äº† `Message` ç±»ï¼Œå®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘é€ã€å®¢æˆ·ç«¯ä»æœåŠ¡å™¨æ¥å—çš„æ•°æ®éƒ½æ˜¯ä¸€ä¸ª `Message` å¯¹è±¡ã€‚è¿™ä¸ªç±»å®ç°äº†æ¶ˆæ¯çš„ç¼–ç å’Œè§£ç ã€‚

- `Message(message: str)` æ„å»ºå‡½æ•°ï¼Œä¼ å…¥ä¸€ä¸ªå­—ç¬¦ä¸²å‚æ•°ï¼Œè¯¥å‚æ•°æ˜¯ä» socket æ¥æ”¶åˆ°çš„æ•°æ®ã€‚

- `Message.prefix` æ¶ˆæ¯å‰ç¼€ï¼Œé»˜è®¤ä¸ºç©ºï¼›å¦‚æœæ¶ˆæ¯å‰ç¼€ä¸ä¸ºç©ºï¼Œè¯´æ˜è¿™æ˜¯ä¸€æ¡ç»è¿‡è½¬å‘çš„æ¶ˆæ¯ï¼ˆå¦‚æœåŠ¡å™¨å°†ä»–äººçš„æ¶ˆæ¯è½¬å‘ç»™ä½ ï¼‰ï¼Œprefix ä¸ºæ¶ˆæ¯ä½œè€…çš„ nickname

- `Message.command` IRC å‘½ä»¤

- `Message.params[]` å‘½ä»¤åé¢è·Ÿç€çš„å‚æ•°åˆ—è¡¨

- `Message.encode()` ç¼–ç æ¶ˆæ¯ï¼Œè¿”å›å­—èŠ‚å‹æ•°æ®ï¼Œå¯ä»¥ç›´æ¥ç”¨äº socket å‘é€ã€‚

ï¼ˆä¸ä¸¥æ ¼ï¼‰æŒ‰ç…§ IRC åè®®ï¼Œä¸‹é¢ç”¨ä¾‹å­è§£é‡Šäº† `message.py` å°†æ¶ˆæ¯ç¼–ç åçš„æ ·å­

ç”±ç”¨æˆ· *miku* å‘é€æ¶ˆæ¯ *hello world!* ç»™ç”¨æˆ· rinï¼ˆä» miku å®¢æˆ·ç«¯å‘é€åˆ°æœåŠ¡å™¨ï¼‰ğŸ”½

```textile
PRIVMSG rin :hello world!
```

ä¸Šæ¡æ¶ˆæ¯ç»è¿‡æœåŠ¡å™¨è½¬å‘ç»™ *rin* æ—¶ï¼ŒæœåŠ¡å™¨ä¼šç»™æ¶ˆæ¯å¸¦ä¸Šå‰ç¼€ï¼ˆprefixï¼‰è¡¨ç¤ºæ¶ˆæ¯æ¥æºæ–¹ğŸ”½

```textile
:miku PRIVMSG rin :hello world!
```

å‘é€æ¶ˆæ¯ç»™åä¸º `#ch1` çš„é¢‘é“åŒç†ï¼Œåªä¸è¿‡é¢‘é“åç§°ä»¥ `#` å¼€å¤´ä»¥æ­¤å’Œç”¨æˆ·åŒºåˆ†ğŸ”½

```textile
PRIVMSG #ch1 :hello world!
```

å…¶ä»–åœ¨é¢‘é“é‡Œçš„ç”¨æˆ·æ”¶åˆ°æ¥è‡ªæ­¤é¢‘é“çš„æ¶ˆæ¯ğŸ”½

```textile
:miku PRIVMSG #ch1 :hello world!
```

### `connection.py`

ç¨ç¨å°è£…äº†ä¸€ä¸‹ socket connectionã€‚

- `Connection.receiveMessage() -> Message` ä» socket é“¾æ¥ä¸­è¯»å‡ºä¸€ä¸ª `Message` å¯¹è±¡ã€‚

- `Connection.sendMessage(message: Message)` å°†ä¸€ä¸ª `Message` å¯¹è±¡å‘é€åˆ° socket

- `Connection.sendMessageWithPrefix(prefix: str, message: Message)` åŒä¸Šï¼Œåªä¸è¿‡ä¼šå¸¦ä¸Š prefix

### `server.py`

- `Server.connDict{}`

å‚¨å­˜ `Connection` å¯¹è±¡çš„å­—å…¸ã€‚æœåŠ¡å™¨ä¸­æœ€å…³é”®çš„æ•°æ®ç»“æ„ã€‚æœåŠ¡å™¨æ ¹æ®è¿™ä¸ªå­—å…¸è¿›è¡Œæ¶ˆæ¯è½¬å‘ã€‚

é”®ä»£è¡¨ `nickname/channel`ï¼Œå€¼æ˜¯ä¸€ä¸ªåˆ—è¡¨ï¼Œå‚¨å­˜å’Œè¿™ä¸ª `nickname/channel` ç›¸å…³çš„ `Connection` å¯¹è±¡ã€‚ä¸¾ä¸ªä¾‹å­ï¼ŒæœåŠ¡å™¨ç›®å‰è¿æ¥äº†ä¸‰ä¸ªç”¨æˆ·ï¼Œåˆ†åˆ«å« `user1` `user2` `user3`ï¼Œå…¶ä¸­ `user1` å’Œ `user3` åŠ å…¥äº† `#channelA` é¢‘é“ï¼Œ`user1` å’Œ `user2` åŠ å…¥äº† `#channelB` é¢‘é“ã€‚ç»“æ„ç±»ä¼¼

```json
{
    "user1": [<ConnectionToUser1>],
    "user2": [<ConnectionToUser2>],
    "user3": [<ConnectionToUser3>],
    "#channelA": [
        <ConnectionToUser1>,
        <ConnectionToUser3>
    ],
    "#channelB": [
        <ConnectionToUser1>,
        <ConnectionToUser2>
    ]
}
```

### `database.py`

æœåŠ¡å™¨ç”¨æ¥å‚¨å­˜ç”¨æˆ·ä¿¡æ¯çš„æ•°æ®åº“ï¼Œä½¿ç”¨ SQLite

é»˜è®¤æ•°æ®åº“å­˜æ”¾åœ¨å½“å‰ç›®å½•ä¸‹çš„ `users.db` æ–‡ä»¶ä¸­

### `dbtool.py`

åˆ—å‡º `users.db` ä¸­æ‰€æœ‰æ¡ç›®ï¼Œå±•ç¤ºæ•°æ®åº“ç”¨

### `gui.py`

æœ¬æ¥æ²¡æœ‰å›¾å½¢ç•Œé¢åŠŸèƒ½å°±å·²ç»å¾ˆå®Œå–„äº†ï¼Œä½†å…¶ä»–ç»„éƒ½åœ¨å·ï¼ŒåŠŸèƒ½åšçš„èŠ±é‡Œèƒ¡å“¨ã€‚æ²¡ä¸ªå›¾å½¢ç•Œé¢å¥½åƒè¯´ä¸è¿‡å»ï¼Œæ²¡åŠæ³•ï¼Œç»™å‘½ä»¤è¡Œå¥—ä¸ªå£³å­å§ã€‚

è¿™ä¸ªæ–‡ä»¶æä¾›äº†ä¸¤ä¸ªå€Ÿå£ï¼Œç”¨æ¥æ›¿æ¢ `print` å’Œ `input` å‡½æ•°

- `windows.terminal.printToTerminal(text: str)`

å°†æ–‡æœ¬æ‰“å°åœ¨ GUI ä¸Šã€‚

- `windows.getInput()`

è·å–ç”¨æˆ·è¾“å…¥çš„å‘½ä»¤ã€‚å¦‚æœç”¨æˆ·æ²¡æœ‰è¾“å…¥ï¼Œä¼šé˜»å¡ç›´åˆ°ç”¨æˆ·è¾“å…¥

é‚£ä¹ˆå®¢æˆ·ç«¯å¦‚ä½•ä½¿ç”¨ GUI å‘¢

åœ¨ `client.py` å¼€å¤´æœ‰ä¸¤å¥

```python
print = window.terminal.printToTerminal
input = window.getInput
```

è¿™æ˜¯å°† python é»˜è®¤çš„ `print` å‡½æ•°å’Œ `input` å‡½æ•°æ›¿æ¢æˆäº† GUI ä¸­çš„æ–¹æ³•ã€‚client å…¶å®å®Œå…¨å¯ä»¥ä¸ä½¿ç”¨å›¾å½¢ç•Œé¢è¿ä½œã€‚
